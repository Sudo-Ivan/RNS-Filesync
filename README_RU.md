# RNS FileSync

> [!ПРЕДУПРЕЖДЕНИЕ]
> Я все еще считаю этот проект экспериментальным, используйте на свой страх и риск.

**Децентрализованная peer-to-peer синхронизация файлов с использованием Reticulum Network Stack**

RNS FileSync обеспечивает автоматическую синхронизацию файлов между устройствами, не требуя центральных серверов, подключения к интернету или облачных сервисов. Он работает через любую сетевую среду, поддерживаемую Reticulum, включая радио, LoRa, WiFi или интернет, что делает его идеальным для автономного, конфиденциального и устойчивого обмена файлами.

## Возможности

- **Peer-to-Peer**: Не требуются центральные серверы или координация
- **Эффективность использования полосы пропускания**: Дельта-синхронизация передает только измененные блоки, а не целые файлы
- **Работает везде**: Работает через радио, LoRa, mesh-сети или интернет
- **Автоматическая синхронизация**: Отслеживает каталоги и синхронизирует изменения в реальном времени
- **Система прав доступа**: Детальный контроль доступа (чтение/запись/удаление)
- **Терминальный интерфейс (TUI)**: Встроенный текстовый интерфейс для мониторинга и управления
- **Мульти-пиринг**: Подключение к нескольким пирам одновременно с mesh-распределением
- **Криптографическая защита**: Сквозное шифрование через транспортный уровень Reticulum

## Быстрый старт

### Предварительные требования

Установите Reticulum Network Stack:

```bash
pip install rns --break-system-packages
```

Или используя pipx:

```bash
pipx install rns
```

### Установка

```bash
git clone https://github.com/Sudo-Ivan/RNS-Filesync.git
cd RNS-Filesync
```

### Основное использование

**1. Запустите первый пир:**

```bash
python rns_filesync.py -d ~/shared
```

Это создаст каталог для синхронизации и отобразит хеш назначения вашего пира в терминальном интерфейсе.

**2. Запустите второй пир и подключитесь:**

На другом устройстве (или в другом терминале) выполните:

```bash
python rns_filesync.py -d ~/shared -p <destination_hash_from_peer1>
```

Ваши файлы будут автоматически синхронизироваться между обоими каталогами. Добавляйте, изменяйте или удаляйте файлы в любом каталоге и наблюдайте за синхронизацией.

### Интерактивные команды

Во время работы вы можете вводить команды в строке приглашения:

- `status` - Показать количество файлов и подключенных пиров
- `peers` - Список всех подключенных пиров с их хешами
- `browse 0` - Просмотр файлов на пире 0
- `download filename.txt` - Скачать конкретный файл с просматриваемого пира
- `logs` - Просмотр подробных сообщений журнала
- `quit` - Выйти из приложения

## Параметры командной строки

```
-d PATH              Каталог для синхронизации (обязательно)
-i NAME              Имя идентификатора (по умолчанию: rns_filesync)
-p HASH              Хеш назначения пира для подключения (можно указывать несколько раз)
-n                   Отключить мониторинг файлов (только разовая синхронизация)
--permissions-file FILE  Загрузить права доступа из файла
--allow HASH         Разрешить конкретный хеш идентификатора пира
--perms LIST         Права для --allow (через запятую: read,write,delete)
--no-tui             Отключить TUI, использовать обычное логирование
-v                   Подробное логирование (-vv для большего, -vvv для отладки)
--config PATH        Путь к каталогу конфигурации Reticulum
```

## Права доступа и контроль доступа

Управляйте тем, кто может читать, записывать или удалять файлы с помощью файла прав доступа.

**Создайте `permissions.conf`:**

```
# Разрешить конкретному пиру полный доступ
a1b2c3d4e5f6g7h8 read,write,delete

# Доступ только для чтения для другого пира
9876543210fedcba read

# Разрешить чтение всем (подстановочный знак)
* read
```

**Использование:**

```bash
python rns_filesync.py -d ~/shared --permissions-file permissions.conf
```

**Или через командную строку:**

```bash
python rns_filesync.py -d ~/shared --allow a1b2c3d4e5f6g7h8 --perms read,write
```

### Типы прав доступа

- `read` - Пир может просматривать список и скачивать файлы
- `write` - Пир может загружать и изменять файлы
- `delete` - Пир может удалять файлы

Без файла прав доступа все пиры имеют полный доступ.

## Как это работает

RNS FileSync следит за каталогом на вашем устройстве. Когда вы добавляете или изменяете файл, он автоматически отправляет его подключенным пирам. Когда пир добавляет или изменяет файл, вы автоматически получаете его.

#### Архитектура

**Транспортный уровень**: Построен на Reticulum Network Stack (RNS) для криптографической адресации на основе идентификаторов и шифрования транспорта.

**Обнаружение изменений файлов**: Мониторит каталог синхронизации каждые 5 секунд, используя сканирование файловой системы со сравнением хешей SHA-256.

**Протокол дельта-синхронизации**:
1. Файлы делятся на блоки по 4 КБ (`BLOCK_SIZE = 4096`)
2. Каждый блок независимо хешируется с помощью SHA-256
3. Хеши блоков обмениваются с пирами
4. Передаются только блоки с отличающимися хешами
5. Получатель применяет дельта-патчи к существующим файлам

**Фрагментация пакетов**: 
- Передача больших файлов использует `RNS.Resource` с автоматическим разделением на части
- Дельта-блоки делятся на под-части по 256 байт (`MAX_PACKET_DATA_SIZE`)
- Под-части отправляются как отдельные пакеты, собираются при получении
- Проверяются хешем SHA-256 после сборки

**Разрешение конфликтов**: Стратегия "последняя запись выигрывает" (Last-write-wins). Самое последнее изменение распространяется на все пиры.

**Mesh-распределение**: Файлы распространяются транзитивно через подключенные пиры. Если A подключен к B, а B подключен к C, файлы синхронизируются A↔B↔C.

#### Типы сообщений

- `file_list` - Инвентаризация файлов с хешами
- `file_list_request` - Запрос списка файлов пира
- `file_request` - Запрос полной передачи файла
- `delta_request` - Запрос дельта-блоков для существующего файла
- `file_chunk` - Передача данных файла/дельты
- `file_complete` - Сигнал завершения передачи с финальным хешем
- `file_update` - Уведомление пиров о локальном изменении файла
- `file_deletion` - Уведомление пиров об удалении локального файла

